name: Deploy Notes API

on:
  workflow_dispatch:
permissions:
  id-token: write
  contents: read


env:
  PROJECT_ID: ${{ secrets.TF_VAR_PROJECT_ID }}
  REGION: ${{ secrets.TF_VAR_REGION }}
  REPO: notes-api
  IMAGE: notes-api
  TAG: latest

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # WIF AUTHENTICATION
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.TF_VAR_PROJECT_ID }}

      - run: gcloud config set project "$PROJECT_ID"
      - run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev -q


  terraform-backend:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4

      # WIF AUTH
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.TF_VAR_PROJECT_ID }}

      - run: gcloud config set project "$PROJECT_ID"

      - name: Ensure Terraform state bucket exists
        run: |
          BUCKET="wif-github-tfstate"
          SA="szakdolgozat-terraform@${PROJECT_ID}.iam.gserviceaccount.com"

          echo "Checking if bucket $BUCKET exists..."
          if ! gcloud storage buckets describe "gs://$BUCKET" --project="$PROJECT_ID" >/dev/null 2>&1; then
            echo "Creating bucket..."
            gcloud storage buckets create "gs://$BUCKET" \
              --project="$PROJECT_ID" \
              --location="$REGION" \
              --uniform-bucket-level-access
          else
            echo "Bucket already exists."
          fi

          echo "Granting storage.admin role to $SA on $BUCKET..."
          gcloud storage buckets add-iam-policy-binding "gs://$BUCKET" \
            --member="serviceAccount:$SA" \
            --role="roles/storage.admin" \
            --project="$PROJECT_ID"

      - name: Enable required Google APIs
        run: |
          gcloud services enable \
            cloudresourcemanager.googleapis.com \
            run.googleapis.com \
            secretmanager.googleapis.com \
            sqladmin.googleapis.com \
            artifactregistry.googleapis.com \
            compute.googleapis.com \
            iam.googleapis.com \
            apigateway.googleapis.com \
            --project="$PROJECT_ID"

      - name: Wait for API Gateway SA
        run: |
          for i in {1..18}; do
            if gcloud iam service-accounts list --project="$PROJECT_ID" --format="value(email)" | grep -q "gcp-sa-apigateway.iam.gserviceaccount.com"; then
              echo "API Gateway SA ready."
              break
            fi
            echo "Waiting... ($i/18)"
            sleep 5
          done


  terraform-validate:
    runs-on: ubuntu-latest
    needs: terraform-backend
    defaults:
      run:
        working-directory: infra
    env:
      TF_VAR_project_id: ${{ secrets.TF_VAR_PROJECT_ID }}
      TF_VAR_region: ${{ secrets.TF_VAR_REGION }}
      TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      # WIF AUTH
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.TF_VAR_PROJECT_ID }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - run: terraform init -input=false
      - run: terraform fmt -recursive
      - run: terraform validate
      - run: terraform plan


  terraform-apply-foundation:
    runs-on: ubuntu-latest
    needs: terraform-validate
    defaults:
      run:
        working-directory: infra
    env:
      TF_VAR_project_id: ${{ secrets.TF_VAR_PROJECT_ID }}
      TF_VAR_region: ${{ secrets.TF_VAR_REGION }}
      TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      # WIF AUTH
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.TF_VAR_PROJECT_ID }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - run: terraform init -input=false

      - run: |
          terraform apply \
            -target=google_artifact_registry_repository.notes_repo \
            -target=google_service_account.notes_sa \
            -target=google_secret_manager_secret.db_password \
            -target=google_secret_manager_secret_version.db_password_version \
            -auto-approve


  test:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install -r requirements.txt black flake8 pytest
      - run: black --check app/ && flake8 app/
      - run: pytest -v || true


  docker-build-push:
    runs-on: ubuntu-latest
    needs: [terraform-apply-foundation, test]
    steps:
      - uses: actions/checkout@v4

      # WIF AUTH
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.TF_VAR_PROJECT_ID }}

      - run: gcloud config set project "$PROJECT_ID"
      - run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev -q

      - uses: docker/setup-buildx-action@v3

      - run: |
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE}:${TAG}"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - run: |
          docker buildx build \
            -t "$IMAGE_URI" \
            --push \
            .


  terraform-apply-app:
    runs-on: ubuntu-latest
    needs: docker-build-push
    defaults:
      run:
        working-directory: infra
    env:
      TF_VAR_project_id: ${{ secrets.TF_VAR_PROJECT_ID }}
      TF_VAR_region: ${{ secrets.TF_VAR_REGION }}
      TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      # WIF AUTH
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.TF_VAR_PROJECT_ID }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - run: terraform init -input=false
      - run: terraform apply -auto-approve


  smoke-test:
    runs-on: ubuntu-latest
    needs: terraform-apply-app
    defaults:
      run:
        working-directory: infra
    env:
      TF_VAR_project_id: ${{ secrets.TF_VAR_PROJECT_ID }}
      TF_VAR_region: ${{ secrets.TF_VAR_REGION }}
      TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      # WIF AUTH
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.TF_VAR_PROJECT_ID }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - run: terraform init -input=false

      - run: |
          GATEWAY_URL=$(terraform output -raw api_gateway_url)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$GATEWAY_URL/notes")
          if [ "$STATUS" -ne 200 ]; then
            echo "Smoke test failed with status $STATUS"
            exit 1
          else
            echo "Smoke test passed successfully!"
          fi


  pipeline-metrics:
    runs-on: ubuntu-latest
    needs: smoke-test
    if: always()
    permissions:
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Generate Pipeline Metrics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/pipeline-metrics.sh
          ./scripts/pipeline-metrics.sh
      - name: Upload Metrics Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pipeline-metrics
          path: metrics.txt
          retention-days: 30